var app=angular.module("testify",["ngMaterial","chieffancypants.loadingBar","ngAnimate","ngMessages","angularMoment","ui.router","ngStorage","restangular","ngFacebook","ngFileUpload","ngImgCrop","ngTextTruncate","ngSanitize","ngCordova"]);-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?(app.constant("apiBase","https://testify-staging.herokuapp.com/api/v1"),app.constant("appBase","/"),app.constant("appUrl","https://testify-staging.herokuapp.com")):(app.constant("appUrl","https://testify-staging.herokuapp.com"),app.constant("appBase","/"),app.constant("apiBase","api/v1")),app.config(["$mdThemingProvider",function(e){var t=e.extendPalette("blue",{contrastDefaultColor:"light",contrastDarkColors:["300"],contrastLightColors:["100","500"],500:"6AA3C8",50:"1C3456",100:"5DADE0",300:"FAFAFA",400:"F4F4F4"}),a=e.extendPalette("green",{contrastDefaultColor:"light",contrastDarkColors:["200","300"],contrastLightColors:["500"],500:"97B6CA",50:"1C3456",100:"5DADE0",200:"e74c3c",300:"FFFFFF",400:"F4F4F4",600:"27ae60",700:"77777E"});e.definePalette("primary",t),e.definePalette("accent",a),e.theme("default").primaryPalette("primary",{"default":"500","hue-1":"50","hue-2":"100","hue-3":"300"}).accentPalette("accent",{"default":"200","hue-1":"600","hue-2":"700"}).warnPalette("red")}]),app.config(["$compileProvider","$logProvider","$animateProvider",function(e,t,a){t.debugEnabled(!1),e.debugInfoEnabled(!1)}]),app.config(["$httpProvider","RestangularProvider","$facebookProvider","apiBase",function(e,t,a,r){a.setAppId(0xa3bf7aae624f),t.setBaseUrl(r),t.setFullResponse(!0),e.interceptors.push(["$q","$location","$localStorage",function(e,t,a,r,s){return{request:function(e){return e.headers=e.headers||{},a.token&&(e.headers.Authorization="Bearer "+a.token),e},response:function(e){var t=e.headers("Authorization");return t&&(t.replace("Bearer ",""),a.token=t),e},responseError:function(r){return(401===r.status||400===r.status||403===r.status)&&("token_expired"==r.data.error?(delete a.token,s.resetProfile(),t.path("/signin")):"token_invalid"==r.data.error?(delete a.token,s.resetProfile(),t.path("/signin")):"Bad Authorization"==r.data.error?(delete a.token,s.resetProfile(),t.path("/signin")):"token_not_provided"==r.data.error&&(delete a.token,s.resetProfile(),t.path("/signin")),console.log("Unauthorized or forbidden")),e.reject(r)}}}])}]),app.run(["$cordovaSplashscreen","$cordovaKeyboard","$cordovaStatusbar",function(e,t,a){window.addEventListener("load",function(){new FastClick(document.body)},!1),function(e,t,a){var r,s=e.getElementsByTagName(t)[0];e.getElementById(a)||(r=e.createElement(t),r.id=a,r.src="//connect.facebook.net/en_US/sdk.js",s.parentNode.insertBefore(r,s))}(document,"script","facebook-jssdk"),-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")&&document.addEventListener("deviceready",function(){a.style(1),a.styleHex("#819CAD"),t.hideAccessoryBar(!0),e.hide()},!1)}]),app.config(["$stateProvider","$urlRouterProvider","$locationProvider","appBase",function(e,t,a,r){e.state("web",{"abstract":!0,templateUrl:"views/web.html"}).state("web.app",{"abstract":!0,url:r,templateUrl:"views/web.app.html"}).state("web.app.login",{url:"login",templateUrl:"views/web.app.login.html"}).state("web.app.signup",{url:"signup",controller:"LoginCtrl",templateUrl:"views/web.app.signup.html"}).state("web.app.logout",{url:"logout",controller:"LogoutCtrl",template:" "}).state("web.app.landing",{url:"",templateUrl:"views/web.app.landing.html"}).state("web.app.forgot",{url:"forgot",templateUrl:"views/web.app.forgot-password.html"}).state("web.app.dashboard",{"abstract":!0,url:"",templateUrl:"views/web.app.dashboard.html"}).state("web.app.dashboard.centered",{"abstract":!0,url:"",templateUrl:"views/web.app.dashboard.centered.html"}).state("web.app.dashboard.centered.home",{url:"home",templateUrl:"views/web.app.dashboard.centered.home.html"}).state("web.app.dashboard.centered.notifications",{url:"notifications",templateUrl:"views/web.app.dashboard.notifications.html"}).state("web.app.dashboard.messages",{url:"messages",templateUrl:"views/web.app.dashboard.messages.html"}).state("web.app.dashboard.message",{url:"messages/:user_id",templateUrl:"views/web.app.dashboard.message.html",controller:"MessageCtrl",resolve:{messagingUser:["Restangular","$stateParams","$q",function(e,t,a){var r=a.defer();return e.one("users",t.user_id).get().then(function(e){r.resolve(e.data)}),r.promise}]}}).state("web.app.dashboard.post",{url:"posts/:hash_id",templateUrl:"views/web.app.dashboard.post.html"}).state("web.app.dashboard.centered.posts",{url:"posts?cat",templateUrl:"views/web.app.dashboard.centered.home.html"}).state("web.app.dashboard.centered.user",{url:"user/:id",resolve:{profile:["$stateParams","Restangular",function(e,t){return t.one("users",e.id).get()}]},views:{"":{templateUrl:"views/web.app.dashboard.centered.profile.html",controller:"ProfileCtrl"},"@web.app.dashboard.centered.user":{templateUrl:"views/web.app.dashboard.profile.activities.html"}}}).state("web.app.dashboard.centered.user.activities",{url:"/activities",templateUrl:"views/web.app.dashboard.profile.activities.html"}).state("web.app.dashboard.centered.user.favorites",{url:"/favorites",templateUrl:"views/web.app.dashboard.profile.favorites.html"}).state("web.app.dashboard.centered.user.taps",{url:"/taps",templateUrl:"views/web.app.dashboard.profile.taps.html"}).state("web.app.dashboard.centered.user.edit",{url:"/edit",views:{"@web.app.dashboard":{templateUrl:"views/web.app.dashboard.profile.edit.html"}}}),t.otherwise(r+"home"),-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")||a.html5Mode({enabled:!0,requireBase:!1})}]);
app.controller("AppCtrl",["$rootScope","$scope","$mdSidenav","$mdMedia","$location","$state","$q","AppService","Auth","Me","appBase","$filter","Pusher","$stateParams","NotificationsService","TokenService","$timeout",function(e,t,i,o,n,a,s,r,c,u,d,l,h,f,g,p,m){t.location=n,t.user=c.userProfile,t.composingPost=!1,t.tokHashId=p.token().hash_id,t.ui={showSearch:!1,showSideNav:a,toggleNav:function(e){"left"===e?(i(e).toggle(),i("right").close()):(i(e).toggle(),i("left").close())},toggleSearchBox:function(){t.ui.showSearch=!t.ui.showSearch}},r.getCategoriesWithCount().then(function(e){for(var i=e.data.length,o=0;i>o;o++)e.data[o].count=l("socialCounter")(e.data[o].count);t.categories=e.data});var v;t.openMenu=function(e,t){v=t,e(t)},t.logout=function(){c.logout()},t.redirect=function(e){a.go(e)},t.menu=[{link:"",state:"web.app.dashboard.centered.home",title:"Feeds",icon:"home",condition:!0,click:""}],t.menuAuth=[{link:"profile",state:"web.app.dashboard.centered.user({id: user.username || user.hash_id})",title:"Profile",icon:"account",condition:"user.authenticated",action:null},{link:"",state:"web.app.dashboard.messages",title:"Messages",icon:"message-text-outline",condition:"user.authenticated",click:""},{link:"",state:"web.app.dashboard.centered.user.favorites({id: user.username || user.hash_id})",title:"Favourites",icon:"star",condition:"user.authenticated",action:null},{link:"",state:"web.app.dashboard.centered.user.edit({id: user.username || user.hash_id})",title:"Preferences",icon:"settings",condition:"user.authenticated",action:null}],t.getSearchResultIcon=function(e){return icon[e]},t.searchIcons={tag:"pound",user:"at"},t.searchRepo=function(e){var t=s.defer();return r.search.getList({q:e}).then(function(e){t.resolve(e.data.plain())},function(){t.reject()}),t.promise},t.app={notifications:{messages:g.MessageNotifications,friend_requests:g.FriendRequestNotifications,general:g.Notifications},messages:{notifications:g.MessageNotifications}}}]);
app.controller("LandingCtrl",["Auth","$state",function(e,t){e.refreshProfile().then(function(){e.userProfile.authenticated===!0&&t.go("web.app.dashboard.centered.home")})}]),app.controller("PostsCtrl",["AppService","PostService","Me","$scope","$state","$stateParams","Restangular","UXService","$document",function(e,t,o,a,s,n,i,r,l){a.posts=t.stream,"web.app.dashboard.post"==s.current.name&&(a.home.status=1,i.one("posts",n.hash_id).get().then(function(e){a.home.posts=[e.data],a.home.status=0})),"web.app.dashboard.centered.posts"==s.current.name&&(t.loadCategorized(n.cat),a.posts=t.categorized)}]),app.controller("LoginCtrl",["$scope","UXService","FB","$q","$state","Auth","Me","appBase",function(e,t,o,a,s,n,i,r){n.userProfile.authenticated===!0&&s.go("web.app.dashboard.centered.home"),e.fb_button="Login with Facebook",o.getLoginStatus(function(t){"connected"===t.status?o.api("/me",function(t){e.fb_logged_in=!0,e.fb_name=t.name,e.fb_button="Continue as "+e.fb_name}):(e.fb_logged_in=!1,e.fb_name="null",e.fb_button="Login with Facebook")}),e.loginFB=function(){n.signinFB().then(function(){s.go("web.app.dashboard.centered.home")},function(e){t.toast(e.data.error)})},e.UXLoginFB=function(){t.UXLoginFB()},e.UXSubmitLogin=function(){t.UXSubmitLogin(e.loginDetails)};e.submitLogin=function(){n.signin(e.loginDetails).then(function(e){s.go("web.app.dashboard.centered.home")},function(e){t.toast("Wrong username or password")})}}]),app.controller("SignupCtrl",["$scope","FB","Auth","$location","$mdDialog","$state",function(e,t,o,a,s,n){var i;e.newUser={},e.signupFb=function(){t.login().then(function(){i()})},i=function(){t.api("/me",{fields:"id,first_name,last_name,email"}).then(function(e){t.logout()},function(e){s.show(s.alert().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!0).title("Login failed!").ariaLabel("Failed login").ok("close"))})},e.submitForm=function(){e.signupForm.$valid&&o.signup(e.newUser).then(function(e){n.go("web.app.dashboard.centered.home")},function(e){})}}]),app.controller("LogoutCtrl",["$scope","Auth","Me",function(e,t,o){t.logout(),console.log("mayama")}]),app.controller("ProfileCtrl",["Restangular","$scope","$stateParams","$state","Auth",function(e,t,o,a,s){t.me=s.userProfile;var n=e.one("users",o.id);t.user={profile:{},activities:{posts:[],loading:!0},favorites:{posts:[],loading:!0},taps:{posts:[],loading:!0}},t.loadUserProfile=function(){e.one("users",o.id).get({profile:!0}).then(function(e){t.user_profile=e.data})},t.loadUserActivities=function(){t.user.activities.loading=!0,n.all("activities").getList().then(function(e){t.user.activities.posts=e.data,t.user.activities.loading=!1})},t.loadUserFavorites=function(){t.user.favorites.loading=!0,n.all("favorites").getList().then(function(e){t.user.favorites.posts=e.data,t.user.favorites.loading=!1})},t.loadUserTaps=function(){t.user.taps.loading=!0,n.all("taps").getList().then(function(e){t.user.taps.posts=e.data,t.user.taps.loading=!1})},t.sendFriendRequest=function(t){e.one("me").all("friends").post({user_id:t})};var i=function(){switch(t.loadUserProfile(),a.current.name){case"web.app.dashboard.user.favorites":t.loadUserFavorites();break;case"web.app.dashboard.user.taps":t.loadUserTaps();break;case"web.app.dashboard.user.activities":t.loadUserActivities();break;default:t.loadUserActivities()}};i()}]),app.controller("ProfileEditCtrl",["Restangular","$scope","$stateParams","$state","Upload","Auth","UXService","apiBase",function(e,t,o,a,s,n,i,r){e.one("me").get({profile:!0}).then(function(e){t.user_profile=e.data}),t.user=n.userProfile,n.userProfile.hash_id!=o.id&&n.userProfile.username!=o.id&&(console.log(o),a.go("web.app.dashboard.centered.home")),t.saveAccountInfo=function(o){e.one("me").post("profile",o).then(function(e){n.userProfile.first_name=o.first_name,n.userProfile.last_name=o.last_name,n.userProfile.username=o.username,t.section_account=!1})},t.saveAboutInfo=function(o){e.one("me").post("profile",o),n.userProfile.location=o.location,null===n.userProfile.profile&&(n.userProfile.profile={}),n.userProfile.profile.favorite_book=o.favorite_book,n.userProfile.profile.favorite_verse=o.favorite_verse,n.userProfile.profile.favorite_parable=o.favorite_parable,n.userProfile.profile.denomination=o.denomination,t.section_about_me=!1},t.uploadAvatar=function(e){t.uploading=!0,s.upload({url:r+"/me/profile/avatar",data:{file:s.dataUrltoBlob(e)}}).then(function(e){n.userProfile.avatar=e.data.url,i.toast("Successfully updated your display picture")},function(){i.toast("Changing display picture wasn't successful")})["finally"](function(){t.uploading=!1,t.picFile=""})},t.upload=function(e){console.log(9),s.upload({url:"https://angular-file-upload-cors-srv.appspot.com/upload",data:{file:s.dataUrltoBlob(e)}}).then(function(e){$timeout(function(){t.result=e.data})},function(e){e.status>0&&(t.errorMsg=e.status+": "+e.data)},function(e){t.progress=parseInt(100*e.loaded/e.total)})},t.changePassword=function(){t.password.newPassword&&t.password.newPassword1&&t.password.newPassword===t.password.newPassword1?e.one("me").post("password",t.password).then(function(e){202==e.status&&i.toast("Successfully changed password")},function(e){i.toast("Something's wrong")}):i.toast("Please repeat the password")}}]),app.controller("MessagesCtrl",["$scope","$state","$stateParams","Restangular","Auth","Pusher","MessageService",function(e,t,o,a,s,n,i){e.chats=i.messages}]),app.controller("MessageCtrl",["$scope","$rootScope","messagingUser","Restangular","Auth","$stateParams","$state","Pusher","NotificationsService","UtilityService",function(e,t,o,a,s,n,i,r,l,c){e.messages=[],e.inputMessage="",e.messagingUser=o;var u=null;n.user_id||i.go("web.app.dashboard.centered.home");var p=function(t){e.messages.push(t),e.$$phase||e.$digest(),$("#messages-container").animate({scrollTop:$("#messages-container")[0].scrollHeight+500},500),l.clearNotifications(u)},f=function(t){d(e.messages)},d=function(t){var o=c.findHighestID(t);a.all("me").all("messages").one(n.user_id).get({after:o}).then(function(t){var o=t.data.length;if(o){for(var a=0;o>a;a++)e.messages.push(t.data[a]);l.clearNotifications(u)}$("#messages-container").animate({scrollTop:$("#messages-container")[0].scrollHeight+500},1)},function(e){})};a.all("me").all("messages").one(n.user_id).getList().then(function(t){u=t.headers("X-CHAT-ID"),chatChannel="private-message-"+u,e.messages=t.data,t.length&&l.clearNotifications(u);var o=r.pusher.subscribe(chatChannel);o.bind("new_message",p),o.bind("pusher:subscription_succeeded",f),$("#messages-container").animate({scrollTop:$("#messages-container")[0].scrollHeight+500},1)},function(e){}),e.sendMessage=function(){e.inputMessage.trim()&&a.all("users").one(n.user_id).all("messages").post({message:e.inputMessage,socket_id:r.pusher.connection.socket_id}).then(function(t){e.messages.push(t.data),e.inputMessage="",$("#messages-container").animate({scrollTop:$("#messages-container")[0].scrollHeight+500},1)},function(e){})},t.$on("$stateChangeStart",function(e,t,o,a,s){r.pusher.unsubscribe(chatChannel)})}]),app.controller("TComposerCtrl",["$scope","UXService","AppService","$mdToast","Me","Upload","apiBase","$timeout","$document","EmojioneService","$q",function(e,t,o,a,s,n,i,r,l,c,u){e.selectedCategories=[],e.files=[],e.newPost={creating:!1},r(function(){emojionearea=$("#tComposerInput").emojioneArea({template:"<editor/><filters/><tabs/>",autoHideFilters:!0,useSprite:!0,placeholder:"Share your testimony...",container:null,hideSource:!0}),e.emojionearea=emojionearea[0].emojioneArea},1),r(function(){angular.element(document.querySelector(".emojionearea-editor")).on("focus",function(){e.composingPost=!0,e.$$phase||e.$apply()})},1050),o.getCategories().then(function(t){e.categories=t.data;for(var o=e.categories.length,a=0;o>a;a++)if("General"==e.categories[a].name){e.selectedCategories.push(e.categories[a]);break}}),e.toggleCatPopup=function(){e.showSelectCatPopup=!e.showSelectCatPopup},e.catsClick=function(t){var o=e.selectedCategories.indexOf(t);o>-1?e.selectedCategories.splice(o,1):e.selectedCategories.push(t)},e.catsExists=function(t){return"General"==t.name&&0===e.categories.length?!0:e.selectedCategories.indexOf(t)>-1};e.removePicture=function(t){e.files.splice(t,1)};var p=function(t){var o=u.defer(),a=[];e.files=t;var s=function(e){e.file=e,e.upload=n.upload({url:i+"/images",data:{file:e}}),e.upload.then(function(s){e.complete=!0,e.result=s.data,a.push(s.data.image_id),t.length==a.length&&o.resolve(a)},function(s){e.failed=!0,t.length==a.length&&o.resolve(a)},function(t){e.progress=Math.min(100,parseInt(100*t.loaded/t.total))})};return t&&t.length&&angular.forEach(t,function(e){s(e)}),o.promise};e.composePost=function(o){post=c.emojione.toShort(e.emojionearea.getText()),anonymous=e.anonymous,post||(post=" "),"undefined"==typeof anonymous?anonymous=0:anonymous.$viewValue===!1||anonymous===!1?anonymous=0:anonymous=1;var a=function(t){e.newPost.creating=!0;for(var o=[],a=e.selectedCategories.length,n=0;a>n;n++)o.push(e.selectedCategories[n].id);s.sendPost({post:t.p,anonymous:t.a,categories:o,images:t.i}).then(function(t){e.newPost.creating=!1,201===t.status&&e.home.posts.unshift(t.data),e.emojionearea.setText(""),e.post="",e.composingPost=!1,e.files=[]},function(t){e.newPost.creating=!1})};e.files.length?p(e.files).then(function(e){a({p:post.trim(),a:anonymous,i:e})}):post.trim()?a({p:post.trim(),a:anonymous,i:[]}):t.toast("Your post has no content!")}}]),app.controller("NotificationsController",["$scope","Restangular","NotificationsService","FriendshipService",function(e,t,o,a){var s={"App\\Post":"created a post","App\\Tap":"tapped on a post","App\\Amen":"said amen to a post","App\\Favorite":"favorited a post","App\\Comment":"commented on a post"};t.one("me").all("friend_requests").getList().then(function(t){e.friend_requests=t.data}),t.one("me").all("notifications").getList({profiles:!0}).then(function(t){e.notifications=[],notifs=t.data;for(var o=0;o<notifs.length;o++)aNotif={content:s[notifs[o].action_type],user:notifs[o].user},e.notifications.push(aNotif)}),e.acceptRequest=a.acceptRequest,e.deleteRelationship=a.deleteRelationship}]),app.controller("UXModalLoginCtrl",["$scope","$mdDialog",function(e,t){e.hide=function(){t.hide()},e.cancel=function(){t.cancel()},e.answer=function(e){t.hide(e)}}]),app.controller("UXModalPostCategorizeCtrl",["$scope","$mdDialog","AppService","selectedCategories",function(e,t,o,a){o.getCategories().then(function(t){e.categories=t.data,console.log(e.actives)}),e.hide=function(){t.hide()},e.cancel=function(){t.cancel()},e.filePostIn=function(o){console.log(e.selectedCategories),t.hide(o)}}]);
app.directive("leftSidenav",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app/left-sidenav.html"}}]),app.directive("rightSidenav",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app/right-sidenav.html"}}]),app.directive("searchbox",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app/searchbox.html"}}]),app.directive("appToolbar",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app/app-toolbar.html"}}]),app.directive("appToolbarNoLogin",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app/app-toolbar-no-login.html"}}]),app.directive("testifyPosts",["PostService",function(t){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/templates/Post/posts.html",scope:{posts:"=testifyPosts",status:"=status"},controller:["$scope",function(o){this.SDeletePost=function(e){t.post(e).remove().then(function(t){var n=o.posts.map(function(t){return t.id}).indexOf(e);o.posts.splice(n,1)})},o.noPosts=!1}]}}]),app.directive("testifyPost",["PostService","CommentService","Auth","UXService","FB","$cordovaFacebook","appUrl","$filter","EmojioneService","isCordova",function(t,o,e,n,s,a,p,r,c,u){return{restrict:"A",require:"^?testifyPosts",scope:{post:"=testifyPost"},templateUrl:"partials/templates/Post/post.html",link:function(m,d,f,h){m.user=e.userProfile,m.CommentsUI={loading:!1,retryButton:!1};var v={"App\\Tap":["tapped into","this post"],"App\\Favorite":["favorited","this post"],"App\\Amen":["said amen","to this post"],"App\\Comment":["commented","on this post"],"App\\Post":["posted","on his wall"]};if(m.post.user_ref_activities&&m.post.user_ref_activities.length>0){interpretation="",i=0;var _,g=m.post.user_ref_activities;if(l=m.post.user_ref_activities.length,1==l)a_t=g[0].action_type,interpretation+=" "+v[a_t][0]+" "+v[a_t][1];else if(2==l)for(_ in g)i++,a_t=g[_].action_type,i==l-1&&(interpretation+=" "+v[a_t][0]),i==l&&(interpretation+=" and "+v[a_t][0]+" "+v[a_t][1]);else if(l>2)for(_ in g)i++,a_t=g[_].action_type,i==l-(l-1)?interpretation+=" "+v[a_t][0]:i<=l-1?interpretation+=", "+v[a_t][0]:l>=i&&(interpretation+=" and "+v[a_t][0]+" "+v[a_t][1]);m.interpretation=interpretation}m.showMore=!1;var y,C,x=m.post.text.split(" ").length;if(C=c.emojione.shortnameToImage(m.post.text),x>60){var P=m.post.text.split(" ");y=P.slice(0,59).join(" ")+"&hellip;",y=c.emojione.shortnameToImage(y),m.optimizedText=y,m.post_truncate=!0}else m.optimizedText=C;m.toggleMore=function(){m.showMore?m.optimizedText=y:m.optimizedText=C,m.showMore=!m.showMore};var A;m.openMenu=function(t,o){A=o,t(o)},m.post.prayer&&(m.amens_count=r("socialCounter")(m.post.amens_count)),m.taps_count=r("socialCounter")(m.post.taps_count),m.comments_count=r("socialCounter")(m.post.comments_count),m.showCommentBox=!1,m.openCommentBox=function(){m.CommentsUI.loading=!0,m.CommentsUI.retryButton=!1,t.post(m.post.id).getList("comments").then(function(t){m.post.comments=t.data,m.CommentsUI.loading=!1},function(t){m.CommentsUI.retryButton=!0,m.CommentsUI.loading=!1}),m.showCommentBox=!0},m.addComment=function(o){var i=function(){m.commentBox&&t.post(m.post.id).post("comments",{text:m.commentBox}).then(function(t){m.post.comments_count++,m.comments_count=r("socialCounter")(m.post.comments_count),m.post.comments.unshift(t.data),m.commentBox=""},function(t){n.toast("Sorry, couldn't post your comment check your network and try again ")})};e.userProfile.authenticated?i():n.signinModal(o).then(function(){i()},function(){n.toast("Sorry, we couldn't sign you check your network and try again")})},m.deleteComment=function(t){var e=o.comment(t);e.remove().then(function(o){var e=m.post.comments.map(function(t){return t.id}).indexOf(t);m.post.comments.splice(e,1),m.post.comments_count--,m.comments_count=r("socialCounter")(m.post.comments_count)})},m.toggleFavorite=function(o){var i=function(){m.post.favorited?(m.post.favorited=!1,m.post.favorites_count--,t.post(m.post.id).one("favorites").remove().then(function(t){m.post.favorited=t.data.status,m.post.favorites_count=t.data.count})):(m.post.favorited=!0,m.post.favorites_count++,t.post(m.post.id).one("favorites").post().then(function(t){m.post.favorited=t.data.status,m.post.favorites_count=t.data.count}))};e.userProfile.authenticated?i():n.signinModal(o).then(function(){i()})},m.toggleTap=function(o){var i=function(){m.post.tapped_into?(m.post.tapped_into=!1,m.post.taps_count--,t.post(m.post.id).one("taps").remove().then(function(t){m.post.tapped_into=t.data.status,m.post.taps_count=t.data.count,m.taps_count=r("socialCounter")(m.post.taps_count)})):(m.post.tapped_into=!0,m.post.taps_count++,t.post(m.post.id).one("taps").post().then(function(t){m.post.tapped_into=t.data.status,m.post.taps_count=t.data.count,m.taps_count=r("socialCounter")(m.post.taps_count)}))};e.userProfile.authenticated?i():n.signinModal(o).then(function(){i()})},m.sayAmen=function(o){var i=function(){return m.post.amen===!0?void n.toast("You have already said Amen to this post"):(m.post.amen=!0,m.post.amens_count++,void t.post(m.post.id).one("amens").post().then(function(t){m.post.amen=t.data.status,m.post.amens_count=t.data.count,m.amens_count=r("socialCounter")(m.post.amens_count)}))};e.userProfile.authenticated?i():n.signinModal(o).then(function(){i()})},m.shareToFb=function(){var t={method:"feed",link:p,picture:p+"/dist/img/testify-fb-share-pic.png",name:"Testify",caption:"Sharing God's goodness",description:m.post.text+" (Tesfify is a community for sharing your testimonies and engaging with other people's testimonies)"};u?a.showDialog(t).then(function(t){},function(t){}):s.ui(t,function(t){})},m.deletePost=function(){h.SDeletePost(m.post.id)}}}}]),app.directive("myIcon",["$timeout",function(t){return{restrict:"E",scope:{icon:"@"},replace:!0,link:function(t,o,e){},template:"<i class='mdi mdi-{{::icon}}'></i>"}}]),app.directive("testifyComposer",["$timeout",function(t){return{restrict:"A",templateUrl:"partials/app/testifyComposer.html",link:function(t,o,e){}}}]);
app.filter("socialCounter",function(){return function(t){return out=t,t&&(t>=999&&999999>t?out=Math.round(t/100)/10+"K":t>=999999&&999999999>t?out=Math.round(t/1e5)/10+"M":t>=999999999&&(out=Math.round(t/1e8)/10+"B")),out}});
app.factory("isCordova",[function(){var e=-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://");return e}]),app.factory("TokenService",["$localStorage",function(e){function t(e){var t=e.replace("-","+").replace("_","/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}return window.atob(t)}var n=function(){var n=e.token,o={};if("undefined"!=typeof n){var a=n.split(".")[1];o=JSON.parse(t(a))}return o},o=function(){return e.token};return{token:n,rawToken:o}}]),app.factory("AppService",["Restangular","Auth","Me","$q","$timeout",function(e,t,n,o,a){var i={posts:[]};t.refreshProfile().then(function(e){});var r=e.service("search"),s=e.all("posts"),u=function(){var t=o.defer();return function n(){e.all("categories").getList().then(function(e){t.resolve(e)},function(){a(function(){n()},1e4)})}(),t.promise},c=function(){var t=o.defer();return function n(){e.all("categories").getList({count:!0}).then(function(e){t.resolve(e)},function(){a(function(){n()},1e4)})}(),t.promise};return{app:i,search:r,getPosts:s,getCategories:u,getCategoriesWithCount:c}}]),app.factory("Pusher",["TokenService","isCordova","apiBase",function(e,t,n){Pusher.log=function(e){window.console&&window.console.log&&window.console.log(e)};var o=new Pusher("b5fa9d11972af2e0b8d1",{encrypted:!0,authEndpoint:n+"/pusher/auth",auth:{headers:{Authorization:"Bearer "+e.rawToken()}}}),a=function(){o.config.auth.headers.Authorization="Bearer "+e.rawToken()};return{pusher:o,headerAuthBearerRefresh:a}}]),app.factory("FB",["isCordova","$window","$facebook",function(e,t,n){return e&&t.facebookConnectPlugin?t.facebookConnectPlugin:n}]),app.factory("UXService",["$mdDialog","$mdToast","Auth","$q","$document",function(e,t,n,o,a){var i=function(t){var n=o.defer();return e.show({controller:"UXModalLoginCtrl",templateUrl:"partials/app/ux.signin.modal.html",parent:document.getElementsByClassName("dialog-holder"),targetEvent:t,clickOutsideToClose:!0}).then(function(e){n.resolve(e)},function(){n.reject()}),n.promise},r=function(t,n){e.show(e.alert().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!0).title(n).ariaLabel(n).ok("OK").targetEvent(t))},s=function(e){t.show(t.simple().content(e).position("top left").parent(a[0].querySelector("body")).hideDelay(7e3))},u=function(){n.signinFB().then(function(){e.hide(!0)},function(){d="Do nothing"})},c=function(t){n.signin(t).then(function(t){e.hide(!0)},function(e){console.log(e)})};return{signinModal:i,alert:r,toast:s,UXLoginFB:u,UXSubmitLogin:c}}]),app.factory("Auth",["$localStorage","Restangular","$q","$state","FB","isCordova","NotificationsService","TokenService","Pusher",function(e,t,n,o,a,i,s,u,c){var f={authenticated:!1,id:null,hash_id:null,name:"Guest",firstName:"Guest",lastName:"Guest",sex:null,location:null,email:null,avatar:null,profile:null};t.setFullResponse(!0);var l=function(){var e=n.defer();return u.token().hash_id&&u.token().exp>Date.now()/1e3?t.one("users",u.token().hash_id).get({profile:!0}).then(function(t){d(t.data),c.headerAuthBearerRefresh(),s.reInitPusher(),e.resolve(!0)},function(t){404==t.status&&(b(),m()),e.resolve(!1)}):b(),e.promise},d=function(e){f.authenticated=!0,f.id=e.id,f.hash_id=e.hash_id,f.name=e.first_name+" "+e.last_name,f.firstName=e.first_name,f.lastName=e.last_name,f.username=e.username,f.location=e.location,f.email=e.email,f.avatar=e.avatar,f.profile=e.profile},h=function(t){e.token=t,f.token=t},p=function(e){var a=n.defer();return t.service("signup").post(e).then(function(e){h(e.data.token),l(),o.go("web.app.dashboard.centered.home"),a.resolve(e.data.token)},function(){a.reject()}),a.promise},g=function(e){var a=n.defer();return t.service("authenticate").post(e).then(function(e){h(e.data.token),l(),o.go("web.app.dashboard.centered.home"),a.resolve(e.data.token)},function(){a.reject()}),a.promise},v=function(){var e=n.defer(),o=function(e){var o=n.defer();return r=e,"connected"===r.status?(json={fb_access_token:r.authResponse.accessToken},t.service("fb-token").post(json).then(function(e){h(e.data.token),l(),o.resolve(e)},function(e){o.reject(e)})):o.reject(),o.promise};return a.login(["public_profile","email"]).then(function(t){o(t).then(function(){e.resolve()},function(t){e.reject(t)})},function(){e.reject()}),e.promise},m=function(){s.unsubscribe(),tokenClaims={},delete e.token,l(),o.go("web.app.login")},b=function(){f.authenticated=!1,f.id=null,f.hash_id=null,f.name="Guest",f.firstName="Guest",f.lastName="Guest",f.sex=null,f.location=null,f.email=null,f.avatar=null};return{signup:p,signin:g,signinFB:v,logout:m,refreshProfile:l,resetProfile:b,userProfile:f}}]),app.factory("Me",["Auth","Restangular","$q","TokenService",function(e,t,n,o){var a=o.token().sub,i=t.one("users",a),r=function(e){return t.all("posts").post({post:e.post,anonymous:e.anonymous,categories:e.categories,images:e.images})};return{id:a,me:i,authenticated:e.userProfile.authenticated,favorites:i.all("favorites"),profile:e.userProfile,sendPost:r}}]),app.factory("PostService",["Restangular","UXService","$q","$timeout",function(e,t,n,o){var a={data:[],status:0},i={data:[],status:0},r=(function(){a.status=1,e.all("posts").getList().then(function(e){a.data=e.data,a.status=0},function(e){a.status=2,t.toast("Something's wrong")})}(),function(n){function o(n){i.status=1,e.all("posts").getList(n).then(function(e){i.data=e.data,i.status=0},function(e){i.status=2,t.toast("Something's wrong")})}o(n?{category:n}:{})});return{stream:a,categorized:i,loadCategorized:r}}]),app.factory("MessageService",["$rootScope","Auth","Restangular","UXService","$q","$timeout",function(e,t,n,o,a,i){var r={data:[]},s=function(){n.one("me").all("messages").getList().then(function(e){for(var n=e.data,o=function(e){for(var n=e.length,o=0;n>o;o++)if(e[o].user_id!=t.userProfile.id)return e[o].user},a=e.data.length,i=0;a>i;i++)n[i].otherUser=o(e.data[i].subs);r.data=e.data},function(e){i(function(){s()},1e4)})}();return{messages:r}}]),app.factory("CommentService",["Restangular","$q",function(e,t){var n=(e.all("comments"),function(t){return e.one("comments",t)});return{comment:n}}]),app.factory("SocialService",["FB","Auth",function(e,t){return{}}]),app.factory("PChannels",["TokenService","Pusher",function(e,t){var n=t.pusher.subscribe("private-notifications-"+e.token().hash_id),o=function(){n.subscribe("private-notifications-"+e.token().hash_id)},a=t.pusher.subscribe("private-notifications-"+e.token().hash_id);return{notifications:a,notifications_subscribe:o,notifications_unsubscribe:function(){return t.pusher.unsubscribe("private-notifications-"+e.token().hash_id)}}}]),app.factory("NotificationsService",["TokenService","Pusher","$state","$stateParams","$rootScope","Restangular",function(e,t,n,o,a,r){var s=null,u=[],c=[],f=[],l=function(e,t){for(var n=e.length,o=0;n>o;o++)if(e[o].id==t.id)return o;return-1},d=function(e){if("web.app.dashboard.message"==n.current.name){var t=e.users.length;for(i=0;i<t;i++)if(e.users[i].hash_id==o.user_id||e.users[i].username==o.user_id)return!0;return!1}},h=function(){if(e.token().hash_id){var n=t.pusher.subscribe("private-notifications-"+e.token().hash_id);s=n,n.bind("new_message",function(e){if(!d(e)){var t=l(u,e);-1==t&&(u.push(e),a.$$phase||a.$digest())}}),n.bind("pusher:subscription_succeeded",function(e){r.one("me").all("messages").all("unread").getList().then(function(e){var t=e.data.length;u.splice(0,e.data.length);for(var n=0;t>n;n++)u.push(e.data[n]);a.$$phase||a.$digest()}),r.one("me").all("notifications").getList().then(function(e){var t=e.data.length;c.splice(0,e.data.length);for(var n=0;t>n;n++)c.push(e.data[n]);a.$$phase||a.$digest()}),r.one("me").all("friend_requests").getList().then(function(e){var t=e.data.length;f.splice(0,e.data.length);for(var n=0;t>n;n++)f.push(e.data[n]);a.$$phase||a.$digest()})}),n.bind("pusher:subscription_error",function(e){})}},p=function(e){r.one("me").one("messages",e).one("read").patch();var t=l(u,e);t>=0&&u.splice(t,1)},g=function(){s.unsubscribe("private-notifications-"+e.token().hash_id)};return h(),{MessageNotifications:u,Notifications:c,FriendRequestNotifications:f,clearNotifications:p,unsubscribe:g,reInitPusher:h}}]),app.factory("UtilityService",function(){var e=function(e){var t=e.length;return e[t-1].id},t=function(e){var t=e.length;return e[t-1].created_at};return{findHighestID:e,findHighestTimestamp:t}}),app.factory("FriendshipService",["Restangular",function(e){var t=function(t){e.one("me").all("friend_requests").post({user_id:t})},n=function(t){e.one("me").one("friend_requests",t).remove()};return{acceptRequest:t,deleteRelationship:n}}]),app.factory("EmojioneService",function(){var e=window.emojione;return e.imageType="png",e.sprites=!0,{emojione:e}});
//# sourceMappingURL=../maps/app.js.map
