var app=angular.module("testify",["ngMaterial","chieffancypants.loadingBar","ngAnimate","ngMessages","angularMoment","ui.router","ngStorage","restangular","facebook","ngFileUpload","ngImgCrop","ngTextTruncate","emojiApp"]);app.constant("appUrl","https://testify-for-testimonies.herokuapp.com"),app.constant("appBase","/"),app.constant("apiBase","/api/v1"),app.config(["FacebookProvider","$httpProvider","RestangularProvider","apiBase",function(e,t,a,r){e.setAppId(0xa3bf7aae624f),a.setBaseUrl(r),t.interceptors.push(["$q","$location","$localStorage",function(e,t,a,r,o){return{request:function(e){return e.headers=e.headers||{},a.token&&(e.headers.Authorization="Bearer "+a.token),e},response:function(e){var t=e.headers("Authorization");return t&&(t.replace("Bearer ",""),a.token=t),e},responseError:function(r){return(401===r.status||400===r.status||403===r.status)&&("token_expired"==r.data.error?(delete a.token,o.resetProfile(),t.path("/signin")):"token_invalid"==r.data.error?(delete a.token,o.resetProfile(),t.path("/signin")):"Bad Authorization"==r.data.error?(delete a.token,o.resetProfile(),t.path("/signin")):"token_not_provided"==r.data.error&&(delete a.token,o.resetProfile(),t.path("/signin")),console.log("Unauthorized or forbidden")),e.reject(r)}}}])}]),app.run(function(){}),app.config(["$mdThemingProvider",function(e){var t=e.extendPalette("blue",{contrastDefaultColor:"light",contrastDarkColors:"200, 300",contrastLightColors:"500",500:"97B6CA",50:"1C3456",100:"5DADE0",200:"e74c3c",300:"FFFFFF",400:"F4F4F4",600:"27ae60",700:"77777E"});e.definePalette("palette",t),e.theme("default").primaryPalette("palette",{"default":"500","hue-1":"50","hue-2":"100","hue-3":"300"}).accentPalette("palette",{"default":"200","hue-1":"600","hue-2":"700"}).warnPalette("red",{}),e.theme("input","default").primaryPalette("grey",{}).backgroundPalette("palette",{"default":"500"}).dark(),e.theme("search","default").primaryPalette("yellow",{}).backgroundPalette("palette",{"default":"50"}).dark()}]),app.config(["$stateProvider","$urlRouterProvider","$locationProvider","appBase",function(e,t,a,r){e.state("web",{"abstract":!0,templateUrl:"views/web.html"}).state("web.app",{"abstract":!0,url:r,templateUrl:"views/web.app.html"}).state("web.app.login",{url:"login",templateUrl:"views/web.app.login.html"}).state("web.app.signup",{url:"signup",controller:"LoginCtrl",templateUrl:"views/web.app.signup.html",data:{showSideNav:!1}}).state("web.app.logout",{url:"logout",controller:"LogoutCtrl",template:" ",data:{showSideNav:!1}}).state("web.app.landing",{url:"",templateUrl:"views/web.app.landing.html"}).state("web.app.dashboard",{"abstract":!0,url:"",templateUrl:"views/web.app.dashboard.html"}).state("web.app.dashboard.home",{url:"home",templateUrl:"views/web.app.dashboard.home.html"}).state("web.app.dashboard.post",{url:"post/:hash_id",templateUrl:"views/web.app.dashboard.post.html"}).state("web.app.dashboard.posts",{url:"posts?cat",templateUrl:"views/web.app.dashboard.home.html"}).state("web.app.dashboard.user",{url:"user/:hash_id",resolve:{profile:["$stateParams","Restangular",function(e,t){return t.one("users",e.hash_id).get()}]},views:{"":{templateUrl:"views/web.app.dashboard.profile.html",controller:"ProfileCtrl"},"@web.app.dashboard.user":{templateUrl:"views/web.app.dashboard.profile.activities.html"}}}).state("web.app.dashboard.user.activities",{url:"/activities",templateUrl:"views/web.app.dashboard.profile.activities.html"}).state("web.app.dashboard.user.favorites",{url:"/favorites",templateUrl:"views/web.app.dashboard.profile.favorites.html"}).state("web.app.dashboard.user.taps",{url:"/taps",templateUrl:"views/web.app.dashboard.profile.taps.html"}).state("web.app.dashboard.user.edit",{url:"/edit",views:{"@web.app.dashboard":{templateUrl:"views/web.app.dashboard.profile.edit.html"}}}),t.otherwise(r+"home"),a.html5Mode({enabled:!0,requireBase:!1})}]);
app.controller("AppCtrl",["$rootScope","$scope","$mdSidenav","$mdMedia","$location","$state","$q","AppService","Auth","Me","appBase",function(e,t,o,n,a,i,s,c,r,u,h){t.location=a,t.user=r.userProfile,t.composingPost=!1,t.tokHashId=r.token.hash_id,t.ui={showSearch:!1,showSideNav:i,toggleNav:function(e){o(e).toggle()},toggleSearchBox:function(){t.ui.showSearch=!t.ui.showSearch}},c.getCategories.then(function(e){t.categories=e.data});var d;t.openMenu=function(e,t){d=t,e(t)},t.logout=function(){r.logout()},t.redirect=function(e){i.go(e)},t.menu=[{link:"",state:"web.app.dashboard.home",title:"Feeds",icon:"home",condition:!0,click:""}],t.menuAuth=[{link:"profile",state:"web.app.dashboard.user({hash_id: tokHashId})",title:"Profile",icon:"account",condition:"user.authenticated",action:null},{link:"",state:"web.app.dashboard.home",title:"Messages",icon:"message-text-outline",condition:"user.authenticated",click:""},{link:"",state:"web.app.dashboard.user.favorites({hash_id: tokHashId})",title:"Favourites",icon:"star",condition:"user.authenticated",action:null},{link:"",state:"web.app.dashboard.user.edit({hash_id: tokHashId})",title:"Preferences",icon:"settings",condition:"user.authenticated",action:null}],t.getSearchResultIcon=function(e){return icon[e]},t.searchIcons={tag:"pound",user:"at"},t.searchRepo=function(e){var t=s.defer();return c.search.getList({q:e}).then(function(e){t.resolve(e.data.plain())},function(){t.reject()}),t.promise}}]);
app.controller("PostsCtrl",["AppService","Me","$scope","$state","$stateParams","Restangular","UXService","$document",function(t,e,o,n,a,i,s,l){o.app=t.app,o.post_status={loading:!1};var u=function(){function e(e){t.getPosts.getList(e).then(function(e){t.app.posts=e.data,o.post_status.loading=!1},function(t){o.post_status.loading=!1,s.toast("Something's wrong")})}o.post_status.loading=!0,e(a.cat?{category:a.cat}:{})};u()}]),app.controller("LoginCtrl",["$scope","UXService","Facebook","$q","$state","Auth","Me","appBase",function(t,e,o,n,a,i,s,l){i.userProfile.authenticated===!0&&a.go("web.app.dashboard.home"),t.fb_button="Login with Facebook",o.getLoginStatus(function(e){"connected"===e.status?o.api("/me",function(e){t.fb_logged_in=!0,t.fb_name=e.name,t.fb_button="Continue as "+t.fb_name}):(t.fb_logged_in=!1,t.fb_name="null",t.fb_button="Login with Facebook")}),t.loginFB=function(){i.signinFB().then(function(){a.go("web.app.dashboard.home")},function(t){e.toast(t.data.error)})},t.UXLoginFB=function(){e.UXLoginFB()},t.UXSubmitLogin=function(){e.UXSubmitLogin(t.loginDetails)};t.submitLogin=function(){i.signin(t.loginDetails).then(function(t){a.go("web.app.dashboard.home")},function(t){e.toast("Wrong username or password")})}}]),app.controller("SignupCtrl",["$scope","Facebook","Auth","$location","$mdDialog","$state",function(t,e,o,n,a,i){var s;t.newUser={},t.signupFb=function(){e.login().then(function(){s()})},s=function(){e.api("/me",{fields:"id,first_name,last_name,email"}).then(function(t){e.logout()},function(t){a.show(a.alert().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!0).title("Login failed!").ariaLabel("Failed login").ok("close"))})},t.submitForm=function(){t.signupForm.$valid&&o.signup(t.newUser).then(function(t){i.go("web.app.dashboard.home")},function(t){})}}]),app.controller("LogoutCtrl",["$scope","Auth","Me",function(t,e,o){e.logout(),console.log("mayama")}]),app.controller("ProfileCtrl",["Restangular","$scope","$stateParams","$state",function(t,e,o,n){var a=t.one("users",o.hash_id);e.user={profile:{},activities:[],favorites:[],taps:[]};var i=function(){a.one("profile").get().then(function(t){e.user.profile=t.data})},s=function(){a.all("activities").getList().then(function(t){e.user.activities=t.data})},l=function(){a.all("favorites").getList().then(function(t){e.user.favorites=t.data})},u=function(){a.all("taps").getList().then(function(t){e.user.taps=t.data})};i(),s(),l(),u()}]),app.controller("ProfileEditCtrl",["Restangular","$scope","$stateParams","$state","Upload","Auth","UXService","apiBase",function(t,e,o,n,a,i,s,l){t.one("users",o.hash_id);e.user=i.userProfile,i.userProfile.hash_id!==o.hash_id&&n.go("web.app.dashboard.home"),e.uploadAvatar=function(t){e.uploading=!0,a.upload({url:l+"/users/"+i.userProfile.hash_id+"/profile/avatar",data:{file:a.dataUrltoBlob(t)}}).then(function(t){i.userProfile.avatar=t.data.url,s.toast("Successfully updated your display picture")},function(){s.toast("Changing display picture wasn't successful")})["finally"](function(){e.uploading=!1,e.picFile=""})},e.upload=function(t){console.log(9),a.upload({url:"https://angular-file-upload-cors-srv.appspot.com/upload",data:{file:a.dataUrltoBlob(t)}}).then(function(t){$timeout(function(){e.result=t.data})},function(t){t.status>0&&(e.errorMsg=t.status+": "+t.data)},function(t){e.progress=parseInt(100*t.loaded/t.total)})}}]),app.controller("TComposerCtrl",["$scope","UXService","AppService","$mdToast","Me","Upload","apiBase","$timeout","$document","$q",function(t,e,o,n,a,i,s,l,u,r){t.selectedCategories=[],t.files=[],t.newPost={creating:!1},o.getCategories.then(function(e){t.categories=e.data;for(var o=t.categories.length,n=0;o>n;n++)if("General"==t.categories[n].name){t.selectedCategories.push(t.categories[n]);break}}),t.toggleCatPopup=function(){t.showSelectCatPopup=!t.showSelectCatPopup},t.catsClick=function(e){var o=t.selectedCategories.indexOf(e);o>-1?t.selectedCategories.splice(o,1):t.selectedCategories.push(e)},t.catsExists=function(e){return"General"==e.name&&0===t.categories.length?!0:t.selectedCategories.indexOf(e)>-1};t.removePicture=function(e){t.files.splice(e,1)};var c=function(e){var o=r.defer(),n=[];t.files=e;var a=function(t){t.file=t,t.upload=i.upload({url:s+"/images",data:{file:t}}),t.upload.then(function(a){t.complete=!0,t.result=a.data,n.push(a.data.image_id),e.length==n.length&&o.resolve(n)},function(a){t.failed=!0,e.length==n.length&&o.resolve(n)},function(e){t.progress=Math.min(100,parseInt(100*e.loaded/e.total))})};return e&&e.length&&angular.forEach(e,function(t){a(t)}),o.promise};t.composePost=function(o){post=t.post,anonymous=t.anonymous,post||(post=" "),"undefined"==typeof anonymous?anonymous=0:anonymous.$viewValue===!1||anonymous===!1?anonymous=0:anonymous=1;var n=function(e){t.newPost.creating=!0;for(var o=[],n=t.selectedCategories.length,i=0;n>i;i++)o.push(t.selectedCategories[i].id);a.sendPost({post:e.p,anonymous:e.a,categories:o,images:e.i}).then(function(e){t.newPost.creating=!1,201===e.status&&t.app.posts.unshift(e.data),t.emojiMessage.rawhtml="",t.post="",t.composingPost=!1,t.files=[]},function(e){t.newPost.creating=!1})};t.files.length?c(t.files).then(function(t){n({p:post.trim(),a:anonymous,i:t})}):post.trim()?n({p:post.trim(),a:anonymous,i:[]}):e.toast("Your post has no content!")}}]),app.controller("UXModalLoginCtrl",["$scope","$mdDialog",function(t,e){t.hide=function(){e.hide()},t.cancel=function(){e.cancel()},t.answer=function(t){e.hide(t)}}]),app.controller("UXModalPostCategorizeCtrl",["$scope","$mdDialog","AppService","selectedCategories",function(t,e,o,n){o.getCategories.then(function(e){t.categories=e.data,console.log(t.actives)}),t.hide=function(){e.hide()},t.cancel=function(){e.cancel()},t.filePostIn=function(o){console.log(t.selectedCategories),e.hide(o)}}]);
app.directive("leftSidenav",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/left-sidenav.html"}}]),app.directive("rightSidenav",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/right-sidenav.html"}}]),app.directive("searchbox",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/searchbox.html"}}]),app.directive("appToolbar",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app-toolbar.html"}}]),app.directive("appToolbarNoLogin",[function(){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"partials/app-toolbar-no-login.html"}}]),app.directive("testifyPosts",["PostService",function(t){return{restrict:"A",transclude:!0,replace:!0,templateUrl:"templates/Post/posts.html",scope:{posts:"=testifyPosts",post_status:"=postStatus"},controller:["$scope",function(e){this.SDeletePost=function(o){t.post(o).remove().then(function(t){var n=e.posts.map(function(t){return t.id}).indexOf(o);e.posts.splice(n,1)})},e.noPosts=!1}]}}]),app.directive("testifyPost",["PostService","CommentService","Auth","UXService","Facebook","appUrl",function(t,e,o,n,s,a){return{restrict:"A",require:"^?testifyPosts",scope:{post:"=testifyPost"},templateUrl:"templates/Post/post.html",link:function(p,r,c,u){p.user=o.userProfile,p.CommentsUI={loading:!1};var m={"App\\Tap":["tapped into","this post"],"App\\Favorite":["favorited","this post"],"App\\Amen":["said amen","to this post"],"App\\Comment":["commented","on this post"]};if(p.post.user_ref_activities&&p.post.user_ref_activities.length>0){interpretation="",i=0;var f,d=p.post.user_ref_activities;if(l=p.post.user_ref_activities.length,1==l)a_t=d[0].action_type,interpretation+=" "+m[a_t][0]+" "+m[a_t][1];else if(2==l)for(f in d)i++,a_t=d[f].action_type,i==l-1&&(interpretation+=" "+m[a_t][0]),i==l&&(interpretation+=" and "+m[a_t][0]+" "+m[a_t][1]);else if(l>2)for(f in d)i++,a_t=d[f].action_type,i==l-(l-1)?interpretation+=" "+m[a_t][0]:i<=l-1?interpretation+=", "+m[a_t][0]:l>=i&&(interpretation+=" and "+m[a_t][0]+" "+m[a_t][1]);p.interpretation=interpretation}var h;p.openMenu=function(t,e){h=e,t(e)},p.showCommentBox=!1,p.openCommentBox=function(){p.showCommentBox===!1&&(p.CommentsUI.loading=!0,t.post(p.post.id).getList("comments").then(function(t){p.post.comments=t.data,p.CommentsUI.loading=!1},function(t){p.CommentsUI.loading=!1})),p.showCommentBox=!0},p.addComment=function(e){var i=function(){p.commentBox&&t.post(p.post.id).post("comments",{text:p.commentBox}).then(function(t){p.post.comments_count++,p.post.comments.unshift(t.data),p.commentBox=""})};o.userProfile.authenticated?i():n.signinModal(e).then(function(){i()},function(){v="Unsuccessful login"})},p.deleteComment=function(t){var o=e.comment(t);o.remove().then(function(e){var o=p.post.comments.map(function(t){return t.id}).indexOf(t);p.post.comments.splice(o,1),p.post.comments_count--})},p.toggleFavorite=function(e){var i=function(){p.post.favorited?(p.post.favorited=!1,p.post.favorites_count--,t.post(p.post.id).one("favorites").remove().then(function(t){p.post.favorited=t.data.status,p.post.favorites_count=t.data.count})):(p.post.favorited=!0,p.post.favorites_count++,t.post(p.post.id).one("favorites").post().then(function(t){p.post.favorited=t.data.status,p.post.favorites_count=t.data.count}))};o.userProfile.authenticated?i():n.signinModal(e).then(function(){i()})},p.toggleTap=function(e){var i=function(){p.post.tapped_into?(p.post.tapped_into=!1,p.post.taps_count--,t.post(p.post.id).one("taps").remove().then(function(t){p.post.tapped_into=t.data.status,p.post.taps_count=t.data.count})):(p.post.tapped_into=!0,p.post.taps_count++,t.post(p.post.id).one("taps").post().then(function(t){p.post.tapped_into=t.data.status,p.post.taps_count=t.data.count}))};o.userProfile.authenticated?i():n.signinModal(e).then(function(){i()})},p.sayAmen=function(e){var i=function(){p.post.amen=!0,p.post.amens_count++,t.post(p.post.id).one("amens").post().then(function(t){p.post.amen=t.data.status,p.post.amens_count=t.data.count})};o.userProfile.authenticated?i():n.signinModal(e).then(function(){i()})},p.shareToFb=function(){s.ui({method:"feed",link:a,picture:a+"/img/testify-fb-share-pic.png",name:"Testify",caption:"Sharing God's goodness",description:p.post.text+" (Tesfify is a community for sharing your testimonies and engaging with other people's testimonies)"},function(t){})},p.deletePost=function(){u.SDeletePost(p.post.id)}}}}]),app.directive("myIcon",["$timeout",function(t){return{restrict:"E",scope:{icon:"@"},replace:!0,link:function(t,e,o){},template:"<i class='mdi mdi-{{icon}}'></i>"}}]),app.directive("testifyComposer",[function(){return{restrict:"A",templateUrl:"partials/testifyComposer.html"}}]);
app.filter("socialCounter",function(){return function(t){return out=t,t&&(t>=999&&999999>t?out=Math.round(t/100)/10+"K":t>=999999&&999999999>t?out=Math.round(t/1e5)/10+"M":t>=999999999&&(out=Math.round(t/1e8)/10+"B")),out}});
app.factory("AppService",["Restangular","Auth","Me",function(e,t,n){var o={posts:[]};t.refreshProfile().then(function(e){});var a=e.service("search"),r=e.all("posts"),i=e.all("categories").getList();return{app:o,search:a,getPosts:r,getCategories:i}}]),app.factory("Auth",["$http","$localStorage","Restangular","$q","$state","Facebook",function(e,t,n,o,a,i){function s(e){var t=e.replace("-","+").replace("_","/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}return window.atob(t)}function u(){var e=t.token,n={};if("undefined"!=typeof e){var o=e.split(".")[1];n=JSON.parse(s(o))}return n}var l={authenticated:!1,id:null,hash_id:null,name:"Guest",firstName:"Guest",lastName:"Guest",sex:null,location:null,email:null,avatar:"img/guest.png"};n.setFullResponse(!0);var c=function(){var e=o.defer();return u().hash_id&&u().exp>Date.now()/1e3?n.one("users",u().hash_id).get().then(function(t){f(t.data),e.resolve(!0)},function(t){404==t.status&&(v(),g()),e.resolve(!1)}):v(),e.promise},f=function(e){l.authenticated=!0,l.id=e.id,l.hash_id=e.hash_id,l.name=e.first_name+" "+e.last_name,l.firstName=e.first_name,l.lastName=e.last_name,l.sex=e.sex,l.location=e.state+" "+e.country,l.email=e.email,l.avatar=e.avatar},p=function(e){t.token=e,l.token=e},d=function(e){var t=o.defer();return n.service("signup").post(e).then(function(e){p(e.data.token),c(),a.go("web.app.dashboard.home"),t.resolve(e.data.token)},function(){t.reject()}),t.promise},h=function(e){var t=o.defer();return n.service("authenticate").post(e).then(function(e){p(e.data.token),c(),a.go("web.app.dashboard.home"),t.resolve(e.data.token)},function(){t.reject()}),t.promise},m=function(){var e=o.defer(),t=function(e){var t=o.defer();return r=e,"connected"===r.status?(json={fb_access_token:r.authResponse.accessToken},n.service("fb-token").post(json).then(function(e){p(e.data.token),c(),t.resolve(e)},function(e){t.reject(e)})):t.reject(),t.promise};return i.login(function(n){t(n).then(function(){e.resolve()},function(t){e.reject(t)})}),e.promise},g=function(){tokenClaims={},delete t.token,c(),a.go("web.app.login")},v=function(){l.authenticated=!1,l.id=null,l.hash_id=null,l.name="Guest",l.firstName="Guest",l.lastName="Guest",l.sex=null,l.location=null,l.email=null,l.avatar="img/guest.png"};return{signup:d,signin:h,signinFB:m,logout:g,refreshProfile:c,resetProfile:v,userProfile:l,token:u()}}]),app.factory("Me",["Auth","Restangular","$q",function(e,t,n){var o=e.token.sub,a=t.one("users",o),r=function(e){return t.all("posts").post({post:e.post,anonymous:e.anonymous,categories:e.categories,images:e.images})};return{id:o,me:a,authenticated:e.userProfile.authenticated,favorites:a.all("favorites"),profile:e.userProfile,sendPost:r}}]),app.factory("PostService",["Restangular","$q",function(e,t){var n=(e.all("posts"),function(t){return e.one("posts",t)});return{post:n}}]),app.factory("CommentService",["Restangular","$q",function(e,t){var n=(e.all("comments"),function(t){return e.one("comments",t)});return{comment:n}}]),app.factory("SocialService",["Facebook","Auth",function(e,t){return{}}]),app.factory("UXService",["$mdDialog","$mdToast","Auth","$q","$document",function(e,t,n,o,a){var r=function(t){var n=o.defer();return e.show({controller:"UXModalLoginCtrl",templateUrl:"partials/ux.signin.modal.html",parent:document.getElementsByClassName("dialog-holder"),targetEvent:t,clickOutsideToClose:!0}).then(function(e){n.resolve(e)},function(){n.reject()}),n.promise},i=function(t,n){e.show(e.alert().parent(angular.element(document.querySelector("body"))).clickOutsideToClose(!0).title(n).ariaLabel(n).ok("OK").targetEvent(t))},s=function(e){t.show(t.simple().content(e).position("top left").parent(a[0].querySelector("body")).hideDelay(7e3))},u=function(){n.signinFB().then(function(){e.hide(!0)},function(){d="Do nothing"})},l=function(t){n.signin(t).then(function(t){e.hide(!0)},function(e){console.log(e)})};return{signinModal:r,alert:i,toast:s,UXLoginFB:u,UXSubmitLogin:l}}]);
//# sourceMappingURL=../maps/app.js.map
